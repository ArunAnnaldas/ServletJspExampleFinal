import com.microsoft.playwright.*;
import io.cucumber.spring.ScenarioScope;
import net.jpmc.tesautotools.spartan.webpro.core.config.TESPlayriteProperties;
import net.jpmc.tesautotools.spartan.webpro.core.framework.BrowserCategory;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.test.context.junit4.SpringRunner;

import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

@RunWith(SpringRunner.class)
@ScenarioScope
public class BrowserFactoryTest {

    @InjectMocks
    private BrowserFactory browserFactory;

    @Mock
    private TESPlayriteProperties tesPlayriteProperties;

    @Mock
    private Playwright playwright;

    @Mock
    private Playwright.BrowserType browserType;

    @Mock
    private Browser browser;

    @Mock
    private BrowserContext browserContext;

    @Mock
    private Page page;

    @Before
    public void setup() {
        MockitoAnnotations.initMocks(this);
        when(playwright.chromium()).thenReturn(browserType);
        when(browserType.launch(any())).thenReturn(browser);
        when(browser.newContext()).thenReturn(browserContext);
        when(browserContext.newPage()).thenReturn(page);
    }

    @Test
    public void testGetBrowser() {
        TESPlayriteProperties.Playrite playrite = new TESPlayriteProperties.Playrite();
        playrite.setBrowser(BrowserCategory.chrome);
        playrite.setHeadless(true);

        when(tesPlayriteProperties.getPlayrite()).thenReturn(playrite);

        Page result = browserFactory.getBrowser(playrite.getBrowser(), playrite.isHeadless());

        assertNotNull(result);
    }

    @Test
    public void testCleanContext() {
        browserFactory.cleanContext();

        verify(browserContext).close();
        verify(browser).close();
        verify(playwright).close();
    }

    @Test
    public void testCountOfBrowserContext() {
        when(browser.contexts().size()).thenReturn(1);

        int count = browserFactory.countOfBrowserContext(browser);

        assertEquals(1, count);
    }

    @Test
    public void testIsBrowserConnected() {
        when(browser.isConnected()).thenReturn(true);

        boolean isConnected = browserFactory.isBrowserConnected(browser);

        assertTrue(isConnected);
    }
}
